#!/bin/bash

CHANGE_FILE=~/android/changelog.html
PROJECT_DIR=~/android/system
FILE1=$PROJECT_DIR/.repo/local_manifests/local_manifests.xml
FILE2=$PROJECT_DIR/.repo/manifest.xml
NOW=$(date +"%a %B %d %r %Y")

if [ ! -d "$PROJECT_DIR" ]; then
  echo "Project directory does not exist"
  exit
fi

rm "$CHANGE_FILE"
touch "$CHANGE_FILE"

echo "<!DOCTYPE html><html><body><pre><b>Changes to CM13 for AWIFI since $NOW</b><br>" > "$CHANGE_FILE"

if [ -e "$FILE1" ]; then
  FILELINES1=`cat $FILE1`
  for LINE1 in $FILELINES1 ; do
      PATH1=`echo $LINE1 | grep path | cut -d"=" -f2 | sed 's/^"//' | sed 's/"$//'`
      if [ ! "$PATH1" == "" ]; then
        if [ -d "$PROJECT_DIR"/"$PATH1" ]; then
          cd "$PROJECT_DIR"/"$PATH1"
          OUT1=`git log HEAD --pretty="%h (%cr) %s" --since="5 days ago"`
          if [ ! "$OUT1" == "" ]; then
            echo "<b>Repo: $PATH1</b>" >> "$CHANGE_FILE"
            echo "$OUT1<br>" >> "$CHANGE_FILE"
          fi
        fi
      fi
  done
fi

if [ -e "$FILE2" ]; then
  FILELINES2=`cat $FILE2`
  for LINE2 in $FILELINES2 ; do
      PATH2=`echo $LINE2 | grep path | cut -d"=" -f2 | sed 's/^"//' | sed 's/"$//'`
      if [ ! "$PATH2" == "" ]; then
        if [ -d "$PROJECT_DIR"/"$PATH2" ]; then
          cd "$PROJECT_DIR"/"$PATH2"
          OUT2=`git log HEAD --pretty="%h (%cr) %s" --since="5 days ago"`
          if [ ! "$OUT2" == "" ]; then
            echo "<b>Repo: $PATH2</b>" >> "$CHANGE_FILE"
            echo "$OUT2<br>" >> "$CHANGE_FILE"
          fi
        fi
      fi
  done
fi

echo "</pre></body></html>" >> "$CHANGE_FILE"

echo ""
echo "Most recent changes:"
echo ""
cat "$CHANGE_FILE" | grep "hours ago" | sed 's/<br>//g'
echo ""
