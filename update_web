#!/bin/bash

## Builds directory of OTA Rest Server
BUILDDIR="/var/www/html/CyanogenModOTA/builds"
## CM out directory of build target
OUTDIR="~/android/system/out/target/product/awifi"
## Changelog location
CHANGE_FILE="~/android/changelog.html"
## End Edit

## Find file name of ROM and set variable
cd "$OUTDIR"
FILE=$(ls cm-13.0-*.zip)

## Check if ROM exists before proceding
if [ ! -e "$FILE" ]; then
  echo "Build Failure! Automatic email notification sent for failed build!"
  SUBJECT="Build Failed!"
  send_mail "$SUBJECT"
  exit
fi

SUBJECT="Build Successful for $FILE"
send_mail "$SUBJECT"
echo "Automatic email notification sent for successful build."

## Remove extension of file name and set variable
NOEXT=${FILE%\.*}

echo ""
echo "Removing previous builds on OTA REST Server."
echo ""

mv "$BUILDDIR"/full/.gitignore "$BUILDDIR"/
rm -rf "$BUILDDIR"/full
mkdir "$BUILDDIR"/full
mv "$BUILDDIR"/.gitignore "$BUILDDIR"/full/

echo "Copying ROM ($FILE) to OTA REST Server."
echo ""
cp "$FILE" "$BUILDDIR"/full/

if [ -e "$CHANGE_FILE" ]; then
  echo "Copying changelog ($NOEXT.html) to OTA REST Server."
  echo ""
  cp "$CHANGE_FILE" "$BUILDDIR"/full/"$NOEXT".html
else
  echo "Changelog not found!"
  echo ""
  exit
fi

echo ""
echo "Done."
echo ""
