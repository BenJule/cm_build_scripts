#!/bin/bash

## Root directory of Apache OTA Rest Server that contains builds
BUILDDIR="/var/www/html/CyanogenModOTA/builds"

## Change to target directory
cd ~/android/system/out/target/product/awifi

## Find file name of new ROM and set variable
FILE=`ls cm-13.0-*.zip`

## Check if ROM exists before proceding
if [ ! -e "$FILE" ]; then
  echo "ROM not found!"
  exit
fi

## Remove extension of file name and set variable
NOEXT=${FILE%\.*}

echo ""
echo "Removing previous builds on OTA REST Server."
echo ""

sudo mv "$BUILDDIR"/full/.gitignore "$BUILDDIR"/
sudo rm -rf "$BUILDDIR"/full
sudo mkdir "$BUILDDIR"/full
sudo mv "$BUILDDIR"/.gitignore "$BUILDDIR"/full/

echo "Copying ROM ($FILE) to OTA REST Server."
sudo cp "$FILE" "$BUILDDIR"/full/

if [ -e ~/android/changelog.txt ]; then
  echo "Copying changelog ($NOEXT.txt) to OTA REST Server."
  sudo cp ~/android/changelog.txt "$BUILDDIR"/full/"$NOEXT".txt
else
  echo "Changelog not found!"
  exit
fi

if [ -e `which oat_unit_test` ]; then
  echo ""
  echo "OTA Unit Test."
  echo ""
  ota_unit_test
fi

echo ""
echo "Done."
echo ""
